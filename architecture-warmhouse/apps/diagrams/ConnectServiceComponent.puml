@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

title Component Diagram - Connect Service (IoT Adapter)

Container(broker, "MQTT Broker", "Infrastructure", "Шина")
ContainerDb(db, "PostgreSQL", "DB", "Для чтения конфигов драйверов (optional)")
System_Ext(hardware, "Physical Devices", "Железо")

Container_Boundary(connect, "Connect Service") {

    Component(driver_manager, "Driver Manager", "Core Logic", "Загружает драйверы, управляет их жизненным циклом")

    Component(mqtt_adapter, "MQTT Adapter", "Messaging", "Преобразует MQTT топики в вызовы драйверов и наоборот")

    Component(polling_scheduler, "Polling Loop", "Timer", "Периодически пинает драйверы для опроса устройств")

    ' --- Driver Implementation ---
    Component(driver_zigbee, "Zigbee Driver", "Interface Implementation", "Работает с Zigbee стиком")
    Component(driver_wifi, "WiFi/HTTP Driver", "Interface Implementation", "Работает с REST API устройств")
    Component(driver_tuya, "Tuya Driver", "Interface Implementation", "Proprietary protocol")

}

' Flow: Initialization
Rel(driver_manager, db, "Load Configs (IPs, Keys)", "SQL")

' Flow: Incoming Command from System
Rel(broker, mqtt_adapter, "Sub: Command (cmd/light/on)")
Rel(mqtt_adapter, driver_manager, "Route Command")
Rel(driver_manager, driver_zigbee, "Call SetState()")
Rel(driver_manager, driver_wifi, "Call SetState()")

' Flow: Polling
Rel(polling_scheduler, driver_manager, "Tick")

' Flow: Hardware Communication
Rel(driver_zigbee, hardware, "Serial/Zigbee")
Rel(driver_wifi, hardware, "HTTP/UDP")

' Flow: Event Reporting
Rel(driver_zigbee, mqtt_adapter, "Return new state")
Rel(mqtt_adapter, broker, "Pub: Event (stat/light/on)")

@enduml

@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

title C4 Container - Warmhouse Smart Home System

Person(user, "Пользователь", "Владелец")

System_Boundary(smart_home, "Smart Home System") {

    Container(web_app, "Web UI", "JS Framework", "SPA")

    Container(core_service, "Core / Management Service", "Go / Node.js", "Единая точка входа.\nОбъединяет: API Gateway, Auth, User Topology, Device Meta.")

    Container(automation_service, "Automation Service", "Go / Node.js", "Исполнение сложной логики и таймеров")

    Container(connect_layer, "Connect Service", "IoT Adapter", "Драйверы и работа с железом")

    Container(notification_service, "Notification Service", "Go / Node.js", "Сервис уведомлений")
    ContainerDb(db_core, "DataBase", "PostreSQL", "Пользователи, дома, комнаты, мета данные устройств")

    Container(broker, "Message Broker", "RabbitMQ / MQTT", "Связующее звено")
}

System_Ext(devices, "Hardware", "Датчики и устройства")

Rel(user, web_app, "Взаимодействие с системой")
Rel(web_app, core_service, "Взаимодействие frontend с backend")

' Core interactions
Rel(core_service, db_core, "RW")
Rel(automation_service, db_core,"RW")
Rel(core_service, broker, "Pub: Команды управления устройствами")
Rel(broker, core_service, "Sub: События от датчиков")
Rel(broker, connect_layer, "Sub: Команды управления устройствами")
Rel(connect_layer, broker, "Pub: События от датчиков")

Rel(automation_service, core_service, "Выполнение автоматических сценариев")
Rel(core_service, automation_service, "Настройка автоматических сценариев")

Rel(broker, notification_service, "Sub: События уведомлений")
Rel(broker, automation_service, "Sub: События от датчиков")
Rel(automation_service, broker, "Pub: События уведомлений")
Rel(notification_service, db_core, "RW")
Rel(connect_layer, devices, "IoT взаимодействие с железом")

@enduml

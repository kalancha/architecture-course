@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

title Component Diagram - Core Service (Management & UI Backend)

Container(web_app, "Web UI", "Frontend", "Клиентское приложение")
Container(broker, "MQTT Broker", "Infrastructure", "Шина событий")
ContainerDb(db, "PostgreSQL", "DB", "Хранение пользователей, метаданных и состояния")

Container_Boundary(core, "Core Service") {

    ' --- API Layer ---
    Component(api_handler, "API Controller", "HTTP/REST", "Роутинг запросов (Gin/Express)")
    Component(auth_middleware, "Auth Middleware", "JWT", "Проверка токенов и прав доступа")

    ' --- Domain Layer (Modules) ---
    Component(user_manager, "User Manager", "Module", "Логика управления домами и комнатами")
    Component(device_registry, "Device Registry", "Module", "Управление списком устройств (Create/Delete/Rename)")
    Component(shadow_service, "Shadow Logic", "Module", "Обеспечивает актуальность 'Тени' (Get/Set State)")

    ' --- Infrastructure / Adapters ---
    Component(repo, "Repository / DAL", "ORM", "SQL запросы (Gorm/TypeORM)")

    Component(mqtt_client, "MQTT Adapter", "Async Client", "Слушает обновления от датчиков, Публикует команды")

}

' --- Relations ---

' Inbound HTTP
Rel(web_app, api_handler, "REST API Calls")
Rel(api_handler, auth_middleware, "Uses")
Rel(auth_middleware, user_manager, "Proxies to")
Rel(auth_middleware, device_registry, "Proxies to")
Rel(auth_middleware, shadow_service, "Proxies to")

' Domain Logic interactions
Rel(user_manager, repo, "Persist User Data")
Rel(device_registry, repo, "Persist Device Meta")

' Shadow Logic (Sticky bit)
Rel(shadow_service, repo, "Read/Update Shadow JSON")
Rel(shadow_service, mqtt_client, "Send Command (Set state)")

' Async Flow (Event Loop)
Rel(broker, mqtt_client, "Sub: Device State Changed")
Rel(mqtt_client, repo, "Update Shadow in DB (Async)", "Write")
Rel(mqtt_client, broker, "Pub: Command Payload")

Rel(repo, db, "SQL (Read/Write)")

@enduml
